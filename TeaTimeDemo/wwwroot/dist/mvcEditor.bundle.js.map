{"version":3,"file":"mvcEditor.bundle.js","mappings":"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","sources":["webpack://teatimedemo_v1/./TeaTimeDemo/wwwroot/js/editor.js"],"sourcesContent":["// editor.js\r\n\r\n// 等待文檔加載完成後執行\r\n$(document).ready(function () {\r\n    initializeQuestionIndices(); // 初始化問題索引\r\n    initializeFillInBlankIndices(); // 初始化填空索引\r\n    initializeTinyMCE(); // 初始化 TinyMCE 編輯器\r\n    updateMceContent(); // 更新編輯器內容\r\n});\r\n\r\n// 初始化填空索引\r\nfunction initializeFillInBlankIndices() {\r\n    window.fillInBlankIndices = {};\r\n\r\n    for (var i = 0; i < window.questionIndex; i++) {\r\n        window.fillInBlankIndices[i] = {};\r\n        var optionContainers = $('#options-' + i + ' .option-container');\r\n        optionContainers.each(function (j) {\r\n            var fillInBlankCount = $(this).find('.fill-in-blank').length;\r\n            window.fillInBlankIndices[i][j] = fillInBlankCount;\r\n        });\r\n    }\r\n}\r\n\r\n// 初始化 TinyMCE 編輯器\r\nfunction initializeTinyMCE() {\r\n    tinymce.init({\r\n        selector: '#editor',\r\n        api_key: 'bd4kr41e6ze0pbf2aykxdz4hsbpnedbrhpjj227b6za85wou', // 替換為您的 API 金鑰\r\n        plugins: 'advlist autolink lists link image charmap preview anchor code table',\r\n        toolbar: 'undo redo | formatselect | bold italic backcolor | code | table | image | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat',\r\n        height: '100%', // 設置編輯器高度為 100%\r\n        image_dimensions: true, // 啟用圖片尺寸調整\r\n        image_advtab: true, // 啟用進階圖片選項\r\n        extended_valid_elements: 'img[src|alt|data-image-id|width|height|style|class]', // 允許 img 標籤包含 data-image-id 屬性\r\n        valid_styles: {\r\n            'img': 'width,height'\r\n        },\r\n        setup: function (editor) {\r\n            // 當編輯器初始化時設定內容\r\n            editor.on('init', function () {\r\n                var initialContent = $('#MceHtml').val();\r\n                editor.setContent(initialContent);\r\n\r\n\r\n                // 如果初始內容為空，從表單欄位生成內容並設置到編輯器\r\n                if (initialContent.trim() === \"\") {\r\n                    updateMceContent();\r\n                } else {\r\n                    // 更新編輯器中的圖片，添加 data-image-id 屬性\r\n                    updateEditorImages();\r\n                }\r\n\r\n\r\n            });\r\n\r\n            // 當內容改變時，同步更新隱藏的 MceHtml 欄位\r\n            editor.on('change keyup', function () {\r\n                tinymce.triggerSave();\r\n                $('#MceHtml').val(editor.getContent());\r\n            });\r\n\r\n            // 當圖片被調整大小時，更新左側表單的寬度和高度\r\n            editor.on('ObjectResized', function (e) {\r\n                var img = e.target;\r\n                if (img.tagName.toLowerCase() === 'img') {\r\n                    var imageId = img.getAttribute('data-image-id');\r\n                    var width = e.width;   // 取得調整後的寬度（數字）\r\n                    var height = e.height; // 取得調整後的高度（數字）\r\n\r\n                    // 更新左邊表單的輸入欄位\r\n                 \r\n                    updateImageDimensionsInForm(imageId, width, height);\r\n                }\r\n            });\r\n        },\r\n        content_style: \"body { font-size:14px; }\", // 根據需要調整編輯器內的字體大小\r\n        image_class_list: [\r\n            { title: 'None', value: '' },\r\n            { title: 'Responsive', value: 'img-responsive' }\r\n        ],\r\n        image_title: true,\r\n        automatic_uploads: true,\r\n\r\n        // 自訂圖片上傳處理器，返回 Promise\r\n        images_upload_handler: function (blobInfo) {\r\n            return new Promise(function (resolve, reject) {\r\n                // 建立 FormData 物件\r\n                var formData = new FormData();\r\n                formData.append('image', blobInfo.blob(), blobInfo.filename());\r\n\r\n                // 發送 AJAX 請求至圖片上傳的 API\r\n                $.ajax({\r\n                    url: '/admin/survey/uploadimage',\r\n                    type: 'POST',\r\n                    data: formData,\r\n                    processData: false,\r\n                    contentType: false,\r\n                    success: function (response) {\r\n                        if (response.success) {\r\n                            // 使用後端返回的圖片 URL\r\n                            resolve(response.imageUrl);\r\n                        } else {\r\n                            reject(response.message || '圖片上傳失敗。');\r\n                        }\r\n                    },\r\n                    error: function () {\r\n                        reject('圖片上傳失敗。');\r\n                    }\r\n                });\r\n            });\r\n        }\r\n    });\r\n}\r\n\r\n// 更新編輯器中的圖片，添加 data-image-id 屬性\r\nfunction updateEditorImages() {\r\n    var editor = tinymce.get('editor');\r\n    var imgs = editor.dom.select('img');\r\n    imgs.forEach(function (img) {\r\n        var src = img.getAttribute('src');\r\n        var normalizedSrc = normalizeImageUrl(src);\r\n        var imageId = window.initialData.imageMappings[normalizedSrc];\r\n        if (imageId) {\r\n            img.setAttribute('data-image-id', imageId);\r\n        }\r\n    });\r\n}\r\n\r\n// 輔助方法：正規化圖片 URL，只保留相對路徑部分\r\nfunction normalizeImageUrl(url) {\r\n    var link = document.createElement('a');\r\n    link.href = url;\r\n    return link.pathname;\r\n}\r\n\r\n\r\n\r\n\r\n\r\n// 更新左側表單中圖片的寬度和高度\r\nfunction updateImageDimensionsInForm(imageId, width, height) {\r\n    // 更新問卷圖片\r\n    $('#survey-image-preview img[data-image-id=\"' + imageId + '\"]').each(function () {\r\n        $(this).css({\r\n            'width': width + 'px',\r\n            'height': height + 'px'\r\n        });\r\n        var imageGroup = $(this).closest('.image-upload-group');\r\n        imageGroup.find('input[name$=\"Widths\"]').val(width);\r\n        imageGroup.find('input[name$=\"Heights\"]').val(height);\r\n        imageGroup.find('input[type=\"range\"][data-target=\"width\"]').val(width);\r\n        imageGroup.find('input[type=\"range\"][data-target=\"height\"]').val(height);\r\n    });\r\n\r\n    // 更新問題圖片\r\n    $('#questions .question-container').each(function () {\r\n        $(this).find('.question-image-preview img[data-image-id=\"' + imageId + '\"]').each(function () {\r\n            $(this).css({\r\n                'width': width + 'px',\r\n                'height': height + 'px'\r\n            });\r\n            var imageGroup = $(this).closest('.image-upload-group');\r\n            imageGroup.find('input[name$=\"Widths\"]').val(width);\r\n            imageGroup.find('input[name$=\"Heights\"]').val(height);\r\n            imageGroup.find('input[type=\"range\"][data-target=\"width\"]').val(width);\r\n            imageGroup.find('input[type=\"range\"][data-target=\"height\"]').val(height);\r\n        });\r\n    });\r\n\r\n    // 更新選項圖片\r\n    $('#questions .question-container').each(function () {\r\n        $(this).find('.option-image-preview img[data-image-id=\"' + imageId + '\"]').each(function () {\r\n            $(this).css({\r\n                'width': width + 'px',\r\n                'height': height + 'px'\r\n            });\r\n            var imageGroup = $(this).closest('.image-upload-group');\r\n            imageGroup.find('input[name$=\"Widths\"]').val(width);\r\n            imageGroup.find('input[name$=\"Heights\"]').val(height);\r\n            imageGroup.find('input[type=\"range\"][data-target=\"width\"]').val(width);\r\n            imageGroup.find('input[type=\"range\"][data-target=\"height\"]').val(height);\r\n        });\r\n    });\r\n}\r\n\r\n// 更新 TinyMCE 編輯器的內容\r\nfunction updateMceContent() {\r\n    var content = generateMceContent();\r\n    $('#MceHtml').val(content);\r\n    tinymce.get('editor').setContent(content);\r\n}\r\n\r\n// 生成 TinyMCE 編輯器的內容\r\nfunction generateMceContent() {\r\n    var title = $('input[name=\"Survey.Title\"]').val();\r\n    var description = $('textarea[name=\"Survey.Description\"]').val();\r\n    var stationName = $('select[name=\"Survey.StationName\"] option:selected').text();\r\n    var questionNum = $('input[name=\"Survey.QuestionNum\"]').val();\r\n\r\n    var surveyImagesHtml = '';\r\n   \r\n\r\n    // 選取所有 survey 圖片預覽\r\n    $('#survey-image-preview img').each(function () {\r\n        var imgSrc = $(this).attr('src');\r\n        var imageId = $(this).attr('data-image-id');\r\n        var width = $(this).css('width').replace('px', '') || 200;\r\n        var height = $(this).css('height').replace('px', '') || 200;\r\n        surveyImagesHtml += `<img src=\"${imgSrc}\" alt=\"問卷圖片\" data-image-id=\"${imageId}\" style=\"width:${width}px; height:${height}px;\" /><br />`;\r\n    });\r\n\r\n\r\n    var questionsHtml = '';\r\n    $('#questions .question-container').each(function () {\r\n        var questionText = $(this).find('input[name$=\".Question.QuestionText\"]').val();\r\n        var answerTypeValue = $(this).find('select[name$=\".Question.AnswerType\"]').val();\r\n        var answerType = $(this).find('select[name$=\".Question.AnswerType\"] option:selected').text();\r\n        var optionsHtml = '';\r\n\r\n        var qIndex = $(this).attr('id').split('-')[1];\r\n\r\n        $(this).find('.option-container').each(function () {\r\n            var optionText = $(this).find('input[name$=\".QuestionOption.OptionText\"]').val();\r\n            var optionIdParts = $(this).attr('id').split('-');\r\n            var optionIndex = optionIdParts[2];\r\n\r\n            // 處理填空標記，將 ${填空1}$ 等替換為輸入框，並根據長度調整大小\r\n            var modifiedOptionText = optionText;\r\n            var fillInBlankIndex = 0;\r\n\r\n            // 正則表達式匹配 ${填空X}$，X為數字\r\n            var fillInBlankRegex = /\\$\\{填空(\\d+)\\}\\$/g;\r\n\r\n            // 獲取該選項的填空長度配置\r\n            var fillInBlankLengths = {};\r\n            var fillInBlanks = [];\r\n            $(this).find('.fill-in-blank').each(function () {\r\n                var blankNumber = $(this).find('h5').text().replace('填空 ', '');\r\n                var length = parseInt($(this).find('input[name$=\".Length\"]').val()) || 5;\r\n                var position = parseInt($(this).find('input[name$=\".Position\"]').val()) || 0;\r\n                var placeholder = $(this).find('input[name$=\".Placeholder\"]').val() || '';\r\n                fillInBlankLengths[blankNumber] = { length: length, placeholder: placeholder };\r\n            });\r\n\r\n            modifiedOptionText = modifiedOptionText.replace(fillInBlankRegex, function (match, p1) {\r\n                var blankNumber = p1;\r\n                var inputName = `QuestionVMs[${qIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].AnswerText`;\r\n                var lengthInfo = fillInBlankLengths[blankNumber] || { length: 5, placeholder: '' };\r\n                var length = lengthInfo.length;\r\n                var placeholder = lengthInfo.placeholder;\r\n\r\n                // 設置輸入框的大小，使用 style 屬性控制寬度\r\n                var inputStyle = `width: ${length * 10}px;`; // 每個字元約 10px，可根據需要調整\r\n\r\n                // 隱藏欄位，存儲長度值（如果需要在後端獲取）\r\n                var hiddenLengthInput = `<input type=\"hidden\" name=\"QuestionVMs[${qIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].Length\" value=\"${length}\" />`;\r\n\r\n                fillInBlankIndex++;\r\n                return `${hiddenLengthInput}<input type=\"text\" name=\"${inputName}\" placeholder=\"${placeholder}\" class=\"form-control fill-in-blank-input\" style=\"${inputStyle}\" />`;\r\n            });       \r\n                       \r\n\r\n            var optionHtml = '';\r\n\r\n            switch (answerType.toLowerCase()) {\r\n                case '單選':\r\n                case 'radio':\r\n                    var optionId = $(this).find('input[name$=\".QuestionOption.Id\"]').val();\r\n                    optionHtml += `<input type=\"radio\" name=\"Questions[${qIndex}].SelectedOption\" value=\"${optionId}\" id=\"option_${optionId}\" required> ` +\r\n                        `<label for=\"option_${optionId}\">${modifiedOptionText}</label><br />`;\r\n                break;\r\n                case '多選':\r\n                case 'checkbox':\r\n                    var optionId = $(this).find('input[name$=\".QuestionOption.Id\"]').val();\r\n                    optionHtml += `<input type=\"checkbox\" name=\"Questions[${qIndex}].SelectedOptions\" value=\"${optionId}\" id=\"option_${optionId}\"> ` +\r\n                        `<label for=\"option_${optionId}\">${modifiedOptionText}</label><br />`;\r\n                    break;\r\n                case '填空':\r\n                case 'text':\r\n                    optionHtml += `<input type=\"text\" name=\"Questions[${qIndex}].AnswerText\" required class=\"form-control\" /><br />`;\r\n                    break;\r\n                case '填空框':\r\n                case 'textarea':\r\n                    optionHtml += `<textarea name=\"Questions[${qIndex}].AnswerText\" required class=\"form-control\"></textarea><br />`;\r\n                    break;\r\n                case '下拉選單':\r\n                case 'select':\r\n                    optionHtml += `<select name=\"Questions[${qIndex}].AnswerText\" class=\"form-select\"><option>${optionText}</option></select><br />`;\r\n                    break;\r\n                default:\r\n                    optionHtml += `${modifiedOptionText}<br />`;\r\n                    break;\r\n            }\r\n          \r\n\r\n            // 直接在當前選項容器內尋找圖片\r\n            var optionImagesHtml = '';\r\n            $(this).find('.option-image-preview img').each(function () {\r\n                var imgSrc = $(this).attr('src');\r\n                var imageId = $(this).attr('data-image-id');\r\n                var width = $(this).css('width').replace('px', '') || 200;\r\n                var height = $(this).css('height').replace('px', '') || 200;\r\n                optionImagesHtml += `<img src=\"${imgSrc}\" alt=\"選項圖片\" data-image-id=\"${imageId}\" style=\"width:${width}px; height:${height}px;\" /><br />`;\r\n            });\r\n\r\n            if (optionImagesHtml) {\r\n                optionHtml += `<br />${optionImagesHtml}`;\r\n            }\r\n\r\n            optionsHtml += optionHtml;\r\n        });\r\n\r\n        // 直接在當前問題容器內尋找圖片\r\n        var questionImagesHtml = '';\r\n        $(this).find('.question-image-preview img').each(function () {\r\n            var imgSrc = $(this).attr('src');\r\n            var imageId = $(this).attr('data-image-id');\r\n            var width = $(this).css('width').replace('px', '') || 200;\r\n            var height = $(this).css('height').replace('px', '') || 200;\r\n            questionImagesHtml += `<img src=\"${imgSrc}\" alt=\"問題圖片\" data-image-id=\"${imageId}\" style=\"width:${width}px; height:${height}px;\" /><br />`;\r\n        });\r\n\r\n\r\n        var questionHtml = `<h3>${questionText} (${answerType})</h3>`;\r\n        if (questionImagesHtml) {\r\n            questionHtml += `<div>${questionImagesHtml}</div>`;\r\n        }\r\n        if (optionsHtml) {\r\n            questionHtml += `<div>${optionsHtml}</div>`;\r\n        }\r\n        questionsHtml += questionHtml;\r\n    });\r\n\r\n    var content = `<h1>${title}<span style=\"font-size: 0.7em; margin-left: 10px;\">` +\r\n        `站別: ${stationName} 頁數：${questionNum}` +\r\n        `</span></h1>` +\r\n        `<p>${description}</p>`;\r\n\r\n    if (surveyImagesHtml) {\r\n        content += `<div>${surveyImagesHtml}</div>`;\r\n    }\r\n\r\n    content += questionsHtml;\r\n\r\n    return content;\r\n}\r\n\r\n// 移除圖片的前端邏輯，通過 Ajax 請求後端刪除圖片\r\nfunction removeImage(imageId) {\r\n    $.ajax({\r\n        url: '/admin/survey/removeimage',\r\n        type: 'POST',\r\n        data: { id: imageId },\r\n        success: function (response) {\r\n            if (response.success) {\r\n                toastr.success(response.message);\r\n                $('img[data-image-id=\"' + imageId + '\"]').closest('.image-upload-group').remove();\r\n                tinymce.get('editor').setContent(tinymce.get('editor').getContent()); // 刷新編輯器內容\r\n                $('#MceHtml').val(tinymce.get('editor').getContent());\r\n                updateMceContent(); // 更新編輯器內容\r\n            } else {\r\n                toastr.error(response.message);\r\n            }\r\n        },\r\n        error: function (xhr) {\r\n            console.log(xhr.responseText);\r\n            toastr.error('刪除圖片時發生錯誤');\r\n        }\r\n    });\r\n}\r\n\r\n// 新增問題的函數\r\nfunction addQuestion() {\r\n    var questionHtml = `\r\n        <div class=\"border p-2 my-3 question-container\" id=\"question-${window.questionIndex}\">\r\n            <h4>問題 ${window.questionIndex + 1}</h4>\r\n            <input type=\"hidden\" name=\"QuestionVMs[${window.questionIndex}].Question.Id\" value=\"0\" />\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">問題描述</label>\r\n                <input name=\"QuestionVMs[${window.questionIndex}].Question.QuestionText\" class=\"form-control\" oninput=\"updateMceContent()\" />\r\n            </div>\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">問題類型</label>\r\n                <select name=\"QuestionVMs[${window.questionIndex}].Question.AnswerType\" class=\"form-select\" onchange=\"updateMceContent()\">\r\n                    ${generateQuestionTypeOptions()}\r\n                </select>\r\n            </div>\r\n\r\n            <!-- 現有問題圖片標籤 -->\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">現有問題圖片</label>\r\n            </div>\r\n\r\n            <!-- 問題圖片預覽區域 -->\r\n            <div class=\"mb-3 question-image-preview\" id=\"question-image-preview-${window.questionIndex}\">\r\n                <!-- 新增的問題圖片會在這裡預覽 -->\r\n            </div>\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">上傳問題圖片</label>\r\n                <div id=\"question-image-upload-container-${window.questionIndex}\">\r\n                    <!-- 初始不顯示圖片上傳欄位 -->\r\n                </div>\r\n                <button type=\"button\" class=\"btn btn-primary\" onclick=\"addQuestionImageUploadField(${window.questionIndex})\">新增圖片+</button>\r\n                <span class=\"text-danger\"></span>\r\n            </div>\r\n\r\n            <!-- 現有選項圖片標籤 -->\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">現有選項圖片</label>\r\n            </div>\r\n\r\n            <!-- 選項顯示區域 -->\r\n            <div id=\"options-${window.questionIndex}\">\r\n                <!-- 預設沒有選項，使用者可以點擊按鈕新增 -->\r\n            </div>\r\n            <button type=\"button\" class=\"btn btn-primary\" onclick=\"addOption(${window.questionIndex})\">新增選項</button>\r\n            <button type=\"button\" class=\"btn btn-danger mt-2\" onclick=\"removeQuestion(${window.questionIndex}, 0)\">刪除問題</button>\r\n        </div>`;\r\n    $('#questions').append(questionHtml);\r\n    window.questionIndex++;\r\n\r\n    // 初始化選項索引\r\n    window.optionsIndices[window.questionIndex - 1] = 0;\r\n\r\n    // 更新 TinyMCE 編輯器的內容\r\n    updateMceContent();\r\n}\r\n\r\n// 生成問題類型的選項 HTML\r\nfunction generateQuestionTypeOptions() {\r\n    var questionTypeList = window.initialData.questionTypeList;\r\n    var options = '';\r\n    questionTypeList.forEach(function (type) {\r\n        options += `<option value=\"${type.Value}\">${type.Text}</option>`;\r\n    });\r\n    return options;\r\n}\r\n\r\n// 刪除問題的函數\r\nfunction removeQuestion(index, questionId) {\r\n    if (questionId) {\r\n        $.ajax({\r\n            url: '/admin/survey/removequestion',\r\n            type: 'POST',\r\n            data: { id: questionId },\r\n            success: function (response) {\r\n                if (response.success) {\r\n                    $('#question-' + index).remove();\r\n                    toastr.success(response.message);\r\n                    reindexQuestions();\r\n                    updateMceContent();\r\n                } else {\r\n                    toastr.error(response.message);\r\n                }\r\n            },\r\n            error: function () {\r\n                toastr.error('刪除問題時發生錯誤');\r\n            }\r\n        });\r\n    } else {\r\n        $('#question-' + index).remove();\r\n        reindexQuestions();\r\n        updateMceContent();\r\n    }\r\n}\r\n\r\n// 重新整理問題索引的函數\r\nfunction reindexQuestions() {\r\n    $('#questions .question-container').each(function (index) {\r\n        $(this).attr('id', `question-${index}`);\r\n        $(this).find('h4').text(`問題 ${index + 1}`);\r\n        $(this).find('input, select, textarea').each(function () {\r\n            var name = $(this).attr('name');\r\n            if (name) {\r\n                name = name.replace(/QuestionVMs\\[\\d+\\]/, `QuestionVMs[${index}]`);\r\n                $(this).attr('name', name);\r\n            }\r\n        });\r\n        var questionId = $(this).find('input[type=\"hidden\"]').val();\r\n        $(this).find('.btn-danger').attr('onclick', `removeQuestion(${index}, ${questionId})`);\r\n        reindexOptions(index);\r\n    });\r\n    window.questionIndex = $('#questions .question-container').length;\r\n}\r\n\r\n// 新增選項的函數\r\nfunction addOption(questionIndex) {\r\n    if (!window.optionsIndices[questionIndex]) {\r\n        window.optionsIndices[questionIndex] = 0;\r\n    }\r\n    var optionIndex = window.optionsIndices[questionIndex];\r\n    var optionHtml = `\r\n        <div class=\"mb-2 option-container\" id=\"option-${questionIndex}-${optionIndex}\">\r\n            <input type=\"hidden\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].QuestionOption.Id\" value=\"0\" />\r\n            <label class=\"form-label\">選項 ${optionIndex + 1}</label>\r\n            <input name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].QuestionOption.OptionText\" class=\"form-control\" oninput=\"updateMceContent()\" />\r\n            <button type=\"button\" class=\"btn btn-danger\" onclick=\"removeOption(${questionIndex}, ${optionIndex}, 0)\">刪除選項</button>\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">上傳選項圖片</label>\r\n                <div id=\"option-image-upload-container-${questionIndex}-${optionIndex}\">\r\n                    <!-- 初始不顯示圖片上傳欄位 -->\r\n                </div>\r\n                <button type=\"button\" class=\"btn btn-primary\" onclick=\"addOptionImageUploadField(${questionIndex}, ${optionIndex})\">新增圖片+</button>\r\n                <span class=\"text-danger\"></span>\r\n            </div>\r\n            <!-- 選項圖片預覽區域 -->\r\n            <div class=\"mb-3 option-image-preview\" id=\"option-image-preview-${questionIndex}-${optionIndex}\">\r\n                <!-- 新增的選項圖片會在這裡預覽 -->\r\n            </div>\r\n\r\n            <!-- 填空相關功能 -->\r\n            <div class=\"mb-3\">\r\n                <label class=\"form-label\">填空</label>\r\n                <div id=\"fill-in-blanks-${questionIndex}-${optionIndex}\">\r\n                    <!-- 填空項目會在這裡新增 -->\r\n                </div>\r\n                <button type=\"button\" class=\"btn btn-secondary\" onclick=\"addFillInBlank(${questionIndex}, ${optionIndex})\">新增填空+</button>\r\n            </div>\r\n            \r\n        </div>`;\r\n    $(`#options-${questionIndex}`).append(optionHtml);\r\n    window.optionsIndices[questionIndex]++;\r\n    updateMceContent();\r\n}\r\n\r\n// 刪除選項的函數\r\nfunction removeOption(questionIndex, optionIndex, optionId) {\r\n    if (optionId) {\r\n        $.ajax({\r\n            url: '/admin/survey/removeoption',\r\n            type: 'POST',\r\n            data: { id: optionId },\r\n            success: function (response) {\r\n                if (response.success) {\r\n                    $(`#option-${questionIndex}-${optionIndex}`).remove();\r\n                    toastr.success(response.message);\r\n                    reindexOptions(questionIndex);\r\n                    updateMceContent();\r\n                } else {\r\n                    toastr.error(response.message);\r\n                }\r\n            },\r\n            error: function () {\r\n                toastr.error('刪除選項時發生錯誤');\r\n            }\r\n        });\r\n    } else {\r\n        $(`#option-${questionIndex}-${optionIndex}`).remove();\r\n        reindexOptions(questionIndex);\r\n        updateMceContent();\r\n    }\r\n}\r\n\r\n// 重新整理選項索引的函數\r\nfunction reindexOptions(questionIndex) {\r\n    var optionContainers = $(`#options-${questionIndex} .option-container`);\r\n    optionContainers.each(function (index) {\r\n        $(this).attr('id', `option-${questionIndex}-${index}`);\r\n        $(this).find('.form-label').text(`選項 ${index + 1}`);\r\n        $(this).find('input, select, textarea').each(function () {\r\n            var name = $(this).attr('name');\r\n            if (name) {\r\n                name = name.replace(/QuestionOptionVMs\\[\\d+\\]/, `QuestionOptionVMs[${index}]`);\r\n                $(this).attr('name', name);\r\n            }\r\n        });\r\n        var optionId = $(this).find('input[type=\"hidden\"]').val();\r\n        $(this).find('.btn-danger').attr('onclick', `removeOption(${questionIndex}, ${index}, ${optionId})`);\r\n        reindexFillInBlanks(questionIndex, index);\r\n    });\r\n    window.optionsIndices[questionIndex] = optionContainers.length;\r\n}\r\n\r\n// 新增問卷圖片上傳欄位的函數\r\nfunction addSurveyImageUploadField() {\r\n    var index = $('#survey-image-upload-container .survey-image-upload-group').length;\r\n    var html = `\r\n        <div class=\"mb-2 survey-image-upload-group image-upload-group\">\r\n            <input type=\"file\" name=\"SurveyImageFiles\" class=\"form-control mb-1\" onchange=\"previewAndSyncImage(this, 'survey')\" />           \r\n        </div>`;\r\n    $('#survey-image-upload-container').append(html);\r\n    updateMceContent(); // 更新編輯器內容\r\n}\r\n\r\n// 新增問題圖片上傳欄位的函數\r\nfunction addQuestionImageUploadField(questionIndex) {\r\n    var index = $(`#question-image-upload-container-${questionIndex} .question-image-upload-group`).length;\r\n    var html = `\r\n        <div class=\"mb-2 question-image-upload-group image-upload-group\">\r\n            <input type=\"file\" name=\"QuestionVMs[${questionIndex}].QuestionImageFiles\" class=\"form-control mb-1\" onchange=\"previewAndSyncImage(this, 'question', ${questionIndex})\" />\r\n\r\n        </div>`;\r\n    $(`#question-image-upload-container-${questionIndex}`).append(html);\r\n    updateMceContent(); // 更新編輯器內容\r\n}\r\n\r\n// 新增選項圖片上傳欄位的函數\r\nfunction addOptionImageUploadField(questionIndex, optionIndex) {\r\n    var index = $(`#option-image-upload-container-${questionIndex}-${optionIndex} .option-image-upload-group`).length;\r\n    var html = `\r\n        <div class=\"mb-2 option-image-upload-group image-upload-group\">\r\n            <input type=\"file\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].OptionImageFiles\" class=\"form-control mb-1\" onchange=\"previewAndSyncImage(this, 'option', ${questionIndex}, ${optionIndex})\" />\r\n      \r\n        </div>`;\r\n    $(`#option-image-upload-container-${questionIndex}-${optionIndex}`).append(html);\r\n    updateMceContent(); // 更新編輯器內容\r\n}\r\n\r\n// 當圖片上傳時，更新 TinyMCE 編輯器中的圖片內容\r\nfunction previewAndSyncImage(input, type, questionIndex, optionIndex) {\r\n    const maxSize = 5 * 1024 * 1024; // 最大5MB\r\n    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];\r\n\r\n    if (input.files && input.files[0]) {\r\n        const file = input.files[0];\r\n\r\n        // 檢查文件類型\r\n        if (!allowedTypes.includes(file.type)) {\r\n            toastr.error('僅允許上傳 JPG、PNG、WEBP 或 GIF 格式的圖片。');\r\n            input.value = ''; // 清空選擇\r\n            return;\r\n        }\r\n\r\n        // 檢查文件大小\r\n        if (file.size > maxSize) {\r\n            toastr.error('圖片大小不得超過 5MB。');\r\n            input.value = '';\r\n            return;\r\n        }\r\n\r\n        var reader = new FileReader();\r\n        reader.onload = function (e) {\r\n            // 確保每個新圖片有唯一的 imageId\r\n            window.newImageIdCounter = window.newImageIdCounter || -1;\r\n            var imageId = window.newImageIdCounter--;\r\n            var defaultWidth = 200; // 預設寬度\r\n            var defaultHeight = 200; // 預設高度\r\n\r\n            // 將填空的提示文字插入到輸入框中\r\n            //var placeholder = $(this).find('input[name$=\".Placeholder\"]').val() || '';\r\n\r\n            // 修改插入的 input 標籤，包含 placeholder 屬性\r\n\r\n            // 插入圖片到編輯器，並添加 data-image-id\r\n            var imgHtml = `<img src=\"${e.target.result}\" alt=\"${type} Image\" data-image-id=\"${imageId}\" width=\"${defaultWidth}\" height=\"${defaultHeight}\" style=\"width:${defaultWidth}px; height:${defaultHeight}px;\" />`;\r\n            var editor = tinymce.get('editor');\r\n            editor.insertContent(imgHtml);\r\n\r\n            // 將圖片插入預覽區域，並添加 data-image-id\r\n            var previewImage = `\r\n                <div class=\"mb-3 image-upload-group\">\r\n                    <img src=\"${e.target.result}\" alt=\"${type} Image\" data-image-id=\"${imageId}\" style=\"width:${defaultWidth}px; height:${defaultHeight}px;\" />\r\n                    \r\n                    <!-- 寬度和高度的輸入欄位及滑桿 -->\r\n                    <div class=\"row\">\r\n                        <div class=\"col\">\r\n                            <label>寬度 (px)</label>\r\n                            <input type=\"number\" name=\"${getImageWidthInputName(type, questionIndex, optionIndex)}\" class=\"form-control\" value=\"${defaultWidth}\" oninput=\"updateImageSize(this)\" />\r\n                            <input type=\"range\" min=\"50\" max=\"1000\" value=\"${defaultWidth}\" class=\"form-range\" oninput=\"syncInputAndRange(this)\" data-target=\"width\" />\r\n                        </div>\r\n                        <div class=\"col\">\r\n                            <label>高度 (px)</label>\r\n                            <input type=\"number\" name=\"${getImageHeightInputName(type, questionIndex, optionIndex)}\" class=\"form-control\" value=\"${defaultHeight}\" oninput=\"updateImageSize(this)\" />\r\n                            <input type=\"range\" min=\"50\" max=\"1000\" value=\"${defaultHeight}\" class=\"form-range\" oninput=\"syncInputAndRange(this)\" data-target=\"height\" />\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <button type=\"button\" class=\"btn btn-danger\" onclick=\"removePreviewImage(this)\">刪除</button>\r\n                </div>`;\r\n\r\n            // 根據類型將預覽圖片插入對應的位置\r\n            if (type === 'survey') {\r\n                $('#survey-image-preview').append(previewImage);\r\n            } else if (type === 'question') {\r\n                $('#question-image-preview-' + questionIndex).append(previewImage);\r\n            } else if (type === 'option') {\r\n                $('#option-image-preview-' + questionIndex + '-' + optionIndex).append(previewImage);\r\n            }\r\n\r\n            updateMceContent(); // 更新 MceHtml\r\n        }\r\n        reader.readAsDataURL(file);\r\n    }\r\n}\r\n\r\n/*\r\n// 根據圖片類型和索引，生成對應的寬度輸入欄位的名稱\r\nfunction getImageWidthInputName(type, questionIndex, optionIndex) {\r\n    if (type === 'survey') {\r\n        return `NewSurveyImageWidths[]`;\r\n    } else if (type === 'question') {\r\n        return `NewQuestionImageWidths[${questionIndex}][]`;\r\n    } else if (type === 'option') {\r\n        return `NewOptionImageWidths[${questionIndex}][${optionIndex}][]`;\r\n    }\r\n}\r\n\r\n// 根據圖片類型和索引，生成對應的高度輸入欄位的名稱\r\nfunction getImageHeightInputName(type, questionIndex, optionIndex) {\r\n    if (type === 'survey') {\r\n        return `NewSurveyImageHeights[]`;\r\n    } else if (type === 'question') {\r\n        return `NewQuestionImageHeights[${questionIndex}][]`;\r\n    } else if (type === 'option') {\r\n        return `NewOptionImageHeights[${questionIndex}][${optionIndex}][]`;\r\n    }\r\n}\r\n*/\r\n\r\n// 刪除預覽圖片\r\nfunction removePreviewImage(button) {\r\n    var imageId = $(button).siblings('img').attr('data-image-id');\r\n    $(button).parent().remove();\r\n    removeImage(imageId); // 刪除圖片\r\n}\r\n\r\n// 更新圖片尺寸並同步到編輯器\r\nfunction updateImageSize(imageInput) {\r\n    var imageGroup = $(imageInput).closest('.image-upload-group');\r\n    var imgElement = imageGroup.find('img');\r\n    var imageId = imgElement.attr('data-image-id');\r\n  \r\n    // 假設第一個數字輸入欄位是寬度，第二個是高度\r\n    var widthInput = imageGroup.find('input[type=\"number\"]').eq(0);\r\n    var heightInput = imageGroup.find('input[type=\"number\"]').eq(1);\r\n\r\n    var newWidth = widthInput.val();\r\n    var newHeight = heightInput.val();\r\n\r\n\r\n    // 更新圖片預覽的尺寸\r\n    imgElement.css({\r\n        'width': newWidth + 'px',\r\n        'height': newHeight + 'px'\r\n    });\r\n\r\n    // 同步更新 TinyMCE 編輯器中的圖片尺寸\r\n    updateImageSizeInEditor(imageId, newWidth, newHeight);\r\n}\r\n\r\n// 同步滑桿和數字輸入框的函數\r\nfunction syncInputAndRange(rangeInput) {\r\n    var target = $(rangeInput).data('target'); // 'width' 或 'height'\r\n    var value = $(rangeInput).val();\r\n\r\n\r\n    var imageGroup = $(rangeInput).closest('.image-upload-group');\r\n    var numberInput;\r\n\r\n    if (target === 'width') {\r\n        numberInput = imageGroup.find('input[type=\"number\"]').eq(0);\r\n    } else if (target === 'height') {\r\n        numberInput = imageGroup.find('input[type=\"number\"]').eq(1);\r\n    }\r\n\r\n    if (numberInput) {\r\n        numberInput.val(value);\r\n        updateImageSize(numberInput[0]);\r\n    }\r\n\r\n \r\n}\r\n\r\n// 初始化問題和選項的索引\r\nfunction initializeQuestionIndices() {\r\n    window.questionIndex = window.initialData.questionCount || 0;\r\n    window.optionsIndices = window.initialData.optionsIndices || {};\r\n}\r\n\r\n// 更新 TinyMCE 編輯器中的圖片尺寸\r\nfunction updateImageSizeInEditor(imageId, newWidth, newHeight) {\r\n    var editor = tinymce.get('editor');\r\n\r\n    // 使用 console.log 來監視變數的值\r\n    console.log('imageId: ' + imageId + '\\nnewWidth: ' + newWidth + '\\nnewHeight: ' + newHeight);\r\n\r\n    // 使用 data-image-id 選取圖片\r\n    var img = editor.dom.select('img[data-image-id=\"' + imageId + '\"]')[0];\r\n\r\n    if (img) {\r\n        if (newWidth !== null && newWidth !== undefined && newWidth !== '') {\r\n            img.style.width = newWidth + 'px';\r\n        }\r\n        if (newHeight !== null && newHeight !== undefined && newHeight !== '') {\r\n            img.style.height = newHeight + 'px';\r\n        }\r\n\r\n        // 通知編輯器內容已更改\r\n        editor.nodeChanged();\r\n\r\n        // 同步更新隱藏的 MceHtml 欄位\r\n        $('#MceHtml').val(editor.getContent());\r\n    } else {\r\n        console.log('TinyMCE 編輯器中未找到 ID 為 ' + imageId + ' 的圖片。');\r\n    }\r\n}\r\n\r\nfunction getImageWidthInputName(type, questionIndex, optionIndex) {\r\n    if (type === 'survey') {\r\n        return `NewSurveyImageWidths[]`;\r\n    } else if (type === 'question') {\r\n        return `QuestionVMs[${questionIndex}].NewQuestionImageWidths[]`;\r\n    } else if (type === 'option') {\r\n        return `QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].NewOptionImageWidths[]`;\r\n    }\r\n}\r\n\r\nfunction getImageHeightInputName(type, questionIndex, optionIndex) {\r\n    if (type === 'survey') {\r\n        return `NewSurveyImageHeights[]`;\r\n    } else if (type === 'question') {\r\n        return `QuestionVMs[${questionIndex}].NewQuestionImageHeights[]`;\r\n    } else if (type === 'option') {\r\n        return `QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].NewOptionImageHeights[]`;\r\n    }\r\n}\r\n\r\n/* ===================== 填空相關功能 ===================== */\r\n\r\n// 新增填空的函數\r\nfunction addFillInBlank(questionIndex, optionIndex) {\r\n    if (!window.fillInBlankIndices[questionIndex]) {\r\n        window.fillInBlankIndices[questionIndex] = {};\r\n    }\r\n    if (!window.fillInBlankIndices[questionIndex][optionIndex]) {\r\n        window.fillInBlankIndices[questionIndex][optionIndex] = 0;\r\n    }\r\n    var fillInBlankIndex = window.fillInBlankIndices[questionIndex][optionIndex];\r\n\r\n    var html = `\r\n        <div class=\"fill-in-blank\" id=\"fill-in-blank-${questionIndex}-${optionIndex}-${fillInBlankIndex}\">\r\n            <h5>填空 ${fillInBlankIndex + 1}</h5>\r\n            <input type=\"hidden\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].Id\" value=\"0\" />\r\n             <!-- 新增 IsDeleted 隱藏欄位，預設為 false -->\r\n            <input type=\"hidden\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].IsDeleted\" value=\"false\" />            \r\n            <div class=\"mb-2\">\r\n                <label>正則表達式</label>\r\n                <input type=\"text\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].RegexPattern\" class=\"form-control\" />\r\n            </div>\r\n            <div class=\"mb-2\">\r\n                <label>長度</label>\r\n                <input type=\"number\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].Length\" class=\"form-control\" value=\"5\" oninput=\"updateMceContent()\" />\r\n            </div>\r\n            <div class=\"mb-2\">\r\n                <label>提示文字</label>\r\n                <input type=\"text\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].Placeholder\" class=\"form-control\" />\r\n            </div>\r\n            <div class=\"mb-2\">\r\n                <label>插入位置</label>\r\n                <input type=\"number\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${fillInBlankIndex}].Position\" class=\"form-control\" oninput=\"updateOptionTextWithBlanks(${questionIndex}, ${optionIndex})\" />\r\n            </div>\r\n            <button type=\"button\" class=\"btn btn-danger\" onclick=\"removeFillInBlank(${questionIndex}, ${optionIndex}, ${fillInBlankIndex}, 0)\">刪除填空</button>\r\n        </div>\r\n    `;\r\n    $('#fill-in-blanks-' + questionIndex + '-' + optionIndex).append(html);\r\n    window.fillInBlankIndices[questionIndex][optionIndex]++;\r\n}\r\n\r\n// 刪除填空的函數\r\nfunction removeFillInBlank(questionIndex, optionIndex, fillInBlankIndex, fillInBlankId) {\r\n    var fillInBlankContainer = $('#fill-in-blank-' + questionIndex + '-' + optionIndex + '-' + fillInBlankIndex);\r\n\r\n    // 標記該填空為刪除狀態\r\n    if (fillInBlankId > 0) {\r\n        // 如果填空已存在於資料庫，標記為刪除\r\n        fillInBlankContainer.find('input[name$=\".IsDeleted\"]').val('true');\r\n    } else {\r\n        // 如果是新添加的填空，直接從 DOM 中移除\r\n        fillInBlankContainer.remove();\r\n    }\r\n\r\n    // 隱藏填空容器\r\n    fillInBlankContainer.hide();\r\n\r\n    // 更新選項描述，移除對應的填空標記\r\n    updateOptionTextWithBlanks(questionIndex, optionIndex);\r\n    updateMceContent();\r\n}\r\n\r\n/* ===================== 重新索引填空 ===================== */\r\nfunction reindexFillInBlanks(questionIndex, optionIndex) {\r\n    var fillInBlankContainers = $('#fill-in-blanks-' + questionIndex + '-' + optionIndex + ' .fill-in-blank');\r\n    var newIndex = 0; // 新的索引，用於命名\r\n\r\n    fillInBlankContainers.each(function (index) {\r\n        // 檢查是否被標記為刪除\r\n        if ($(this).find('input[name$=\".IsDeleted\"]').val() === 'true') {\r\n            return; // 跳過已刪除的填空\r\n        }\r\n\r\n        // 重新設定 ID 和標題\r\n        $(this).attr('id', 'fill-in-blank-' + questionIndex + '-' + optionIndex + '-' + newIndex);\r\n        $(this).find('h5').text('填空 ' + (newIndex + 1));\r\n\r\n        // 重新設定名稱屬性\r\n        $(this).find('input, select, textarea').each(function () {\r\n            var name = $(this).attr('name');\r\n            if (name) {\r\n                name = name.replace(/FillInBlanks\\[\\d+\\]/, 'FillInBlanks[' + newIndex + ']');\r\n                $(this).attr('name', name);\r\n            }\r\n        });\r\n\r\n        // 更新刪除按鈕的 onclick 事件\r\n        $(this).find('.btn-danger').attr('onclick', 'removeFillInBlank(' + questionIndex + ', ' + optionIndex + ', ' + newIndex + ', 0)');\r\n\r\n        newIndex++;\r\n    });\r\n    window.fillInBlankIndices[questionIndex][optionIndex] = newIndex;\r\n    updateOptionTextWithBlanks(questionIndex, optionIndex);\r\n}\r\n\r\n\r\n\r\n/* === 更新選項描述中的填空標記 =======* @param {number} questionIndex - 問題的索引\r\n * ======================================@param {number} optionIndex - 選項的索引============== */\r\nfunction updateOptionTextWithBlanks(questionIndex, optionIndex) {\r\n    var optionContainer = $('#option-' + questionIndex + '-' + optionIndex);\r\n    var optionTextInput = optionContainer.find('input[name$=\".QuestionOption.OptionText\"]');\r\n    var originalOptionText = optionTextInput.data('original-text') || optionTextInput.val();\r\n\r\n    // 保存原始的選項文本\r\n    if (!optionTextInput.data('original-text')) {\r\n        optionTextInput.data('original-text', originalOptionText);\r\n    }\r\n\r\n    var fillInBlanks = optionContainer.find('.fill-in-blank');\r\n    var optionText = optionTextInput.data('original-text'); // 重置為原始文本\r\n\r\n    // 收集填空的插入位置和佔位符\r\n    var placeholders = [];\r\n    fillInBlanks.each(function () {\r\n        // 檢查是否被標記為刪除\r\n        if ($(this).find('input[name$=\".IsDeleted\"]').val() === 'true') {\r\n            return; // 跳過已刪除的填空\r\n        }\r\n        var position = parseInt($(this).find('input[name$=\".Position\"]').val()) || 0;\r\n        var blankNumber = $(this).find('h5').text().replace('填空 ', '');\r\n        placeholders.push({ position: position, placeholder: '${填空' + blankNumber + '}$' });\r\n    });\r\n\r\n    // 按插入位置從後往前排序，避免索引錯誤\r\n    placeholders.sort(function (a, b) {\r\n        return b.position - a.position;\r\n    });\r\n\r\n    // 將佔位符插入到選項文本中\r\n    placeholders.forEach(function (item) {\r\n        var pos = item.position;\r\n        if (pos < 0) pos = 0;\r\n        if (pos > optionText.length) pos = optionText.length;\r\n        optionText = optionText.slice(0, pos) + item.placeholder + optionText.slice(pos);\r\n    });\r\n\r\n    optionTextInput.val(optionText);\r\n    updateMceContent();\r\n}\r\n\r\n// 生成填空長度配置\r\nfunction generateFillInBlankConfigs(questionIndex, optionIndex) {\r\n    var optionContainer = $('#option-' + questionIndex + '-' + optionIndex);\r\n    var optionText = optionContainer.find('input[name$=\".QuestionOption.OptionText\"]').val();\r\n\r\n    // 正則表達式匹配 ${填空X}$，X為數字\r\n    var fillInBlankRegex = /\\$\\{填空(\\d+)\\}\\$/g;\r\n    var match;\r\n    var fillInBlankNumbers = [];\r\n\r\n    while ((match = fillInBlankRegex.exec(optionText)) !== null) {\r\n        fillInBlankNumbers.push(match[1]);\r\n    }\r\n\r\n    var fillInBlankConfigsContainer = optionContainer.find('#fill-in-blank-configs-' + questionIndex + '-' + optionIndex);\r\n    fillInBlankConfigsContainer.empty(); // 清空之前的配置\r\n\r\n    fillInBlankNumbers.forEach(function (number, index) {\r\n        var html = `\r\n            <div class=\"fill-in-blank-config\" data-blank-number=\"${number}\">\r\n                <label>填空${number} 長度</label>\r\n                <input type=\"number\" name=\"QuestionVMs[${questionIndex}].QuestionOptionVMs[${optionIndex}].FillInBlanks[${index}].Length\" class=\"form-control\" value=\"5\" />\r\n            </div>\r\n        `;\r\n        fillInBlankConfigsContainer.append(html);\r\n    });\r\n\r\n    updateMceContent();\r\n}\r\n\r\n\r\n/* ===================== 當填空長度改變時，更新編輯器內容 ===================== */\r\n$(document).on('input', 'input[name$=\".Length\"]', function () {\r\n    updateMceContent();\r\n});\r\n"],"names":["updateMceContent","content","title","$","val","description","stationName","text","questionNum","surveyImagesHtml","each","imgSrc","this","attr","imageId","width","css","replace","height","concat","questionsHtml","questionText","find","answerType","optionsHtml","qIndex","split","optionText","optionIndex","modifiedOptionText","fillInBlankIndex","fillInBlankLengths","blankNumber","length","parseInt","placeholder","match","p1","inputName","lengthInfo","inputStyle","hiddenLengthInput","optionHtml","toLowerCase","optionId","optionImagesHtml","questionImagesHtml","questionHtml","generateMceContent","tinymce","get","setContent","document","ready","window","questionIndex","initialData","questionCount","optionsIndices","fillInBlankIndices","i","j","fillInBlankCount","initializeFillInBlankIndices","init","selector","api_key","plugins","toolbar","image_dimensions","image_advtab","extended_valid_elements","valid_styles","setup","editor","on","initialContent","trim","dom","select","forEach","img","url","link","normalizedSrc","getAttribute","createElement","href","pathname","imageMappings","setAttribute","triggerSave","getContent","e","target","tagName","imageGroup","closest","content_style","image_class_list","value","image_title","automatic_uploads","images_upload_handler","blobInfo","Promise","resolve","reject","formData","FormData","append","blob","filename","ajax","type","data","processData","contentType","success","response","imageUrl","message","error"],"sourceRoot":""}